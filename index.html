<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BMS Central Dashboard - Admin</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 300px;
            background: #2c3e50;
            color: white;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .sidebar-header {
            padding: 20px;
            background: #34495e;
            border-bottom: 1px solid #465c71;
        }

        .sidebar-header h2 {
            color: white;
            font-size: 1.3em;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            color: #bdc3c7;
            font-size: 0.9em;
        }

        .device-list {
            padding: 10px;
        }

        .device-item {
            padding: 15px;
            margin: 5px 0;
            background: #34495e;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }

        .device-item:hover {
            background: #3498db;
            transform: translateX(5px);
        }

        .device-item.active {
            background: #3498db;
            border-left-color: #e74c3c;
        }

        .device-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .device-name {
            font-weight: bold;
            font-size: 1.1em;
        }

        .device-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .status-online {
            background: #27ae60;
            color: white;
        }

        .status-offline {
            background: #e74c3c;
            color: white;
        }

        .device-info-small {
            font-size: 0.9em;
            color: #bdc3c7;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            background: white;
            overflow-y: auto;
        }

        .main-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .main-header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .main-header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .connection-status {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .status-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .status-connected {
            background: #28a745;
        }

        .status-disconnected {
            background: #dc3545;
        }

        .status-connecting {
            background: #ffc107;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* BMS Interface (similar to index.html) */
        .bms-interface {
            padding: 20px;
            display: none;
        }

        .bms-interface.active {
            display: block;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .card h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .value {
            font-size: 2.5em;
            font-weight: bold;
            color: #3498db;
            text-align: center;
            margin-bottom: 10px;
        }

        .unit {
            text-align: center;
            color: #666;
            font-size: 1.1em;
        }

        .cell-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .cell {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px 10px;
            text-align: center;
            font-weight: bold;
            transition: all 0.3s;
        }

        .cell:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .cell-number {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .cell-value {
            font-size: 1.1em;
            color: #333;
        }

        .voltage-high {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .voltage-low {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .voltage-normal {
            background: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }

        .resistance-high {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }

        .resistance-low {
            background: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }

        .resistance-normal {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        /* Control Buttons */
        .control-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .control-section h2 {
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #feca57 0%, #ff9ff3 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #48dbfb 0%, #0abde3 100%);
        }

        /* Alerts */
        .alert {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px;
            border: 1px solid #f5c6cb;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 20px;
            border: 1px solid #c3e6cb;
        }

        /* Welcome Screen */
        .welcome-screen {
            text-align: center;
            padding: 100px 20px;
            color: #666;
        }

        .welcome-screen h2 {
            font-size: 2.5em;
            margin-bottom: 20px;
            color: #333;
        }

        .welcome-screen p {
            font-size: 1.2em;
            margin-bottom: 30px;
        }

        .welcome-icon {
            font-size: 5em;
            margin-bottom: 30px;
            opacity: 0.3;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>üîß BMS Dashboard</h2>
                <p>Qu·∫£n l√Ω ESP32 BMS</p>
            </div>
            
            <div class="device-list" id="device-list">
                <!-- Devices will be populated here -->
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Connection Status -->
            <div class="connection-status">
                <h3>
                    <span id="mqtt-status-indicator" class="status-indicator status-disconnected"></span>
                    <span id="mqtt-status-text">ƒêang k·∫øt n·ªëi MQTT...</span>
                </h3>
                <p id="mqtt-info">K·∫øt n·ªëi t·ªõi broker.hivemq.com</p>
            </div>

            <div id="alerts"></div>

            <!-- Welcome Screen -->
            <div class="welcome-screen" id="welcome-screen">
                <div class="welcome-icon">üîã</div>
                <h2>Ch√†o m·ª´ng ƒë·∫øn v·ªõi BMS Dashboard</h2>
                <p>Ch·ªçn m·ªôt ESP32 t·ª´ danh s√°ch b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu gi√°m s√°t</p>
            </div>

            <!-- BMS Interface -->
            <div class="bms-interface" id="bms-interface">
                <!-- Main Header -->
                <div class="main-header">
                    <h1 id="selected-device-title">ESP32 BMS Monitor</h1>
                    <p id="selected-device-subtitle">Gi√°m s√°t th·ªùi gian th·ª±c</p>
                </div>

                <!-- Main Info Grid -->
                <div class="grid">
                    <div class="card">
                        <h3>üîã Th√¥ng tin ch√≠nh</h3>
                        <div class="value" id="battery-voltage">--</div>
                        <div class="unit">ƒêi·ªán √°p (V)</div>
                    </div>
                    
                    <div class="card">
                        <h3>‚ö° D√≤ng ƒëi·ªán</h3>
                        <div class="value" id="current">--</div>
                        <div class="unit">D√≤ng ƒëi·ªán (A)</div>
                    </div>
                    
                    <div class="card">
                        <h3>üìä M·ª©c s·∫°c</h3>
                        <div class="value" id="soc">--</div>
                        <div class="unit">SOC (%)</div>
                    </div>
                    
                    <div class="card">
                        <h3>üí™ C√¥ng su·∫•t</h3>
                        <div class="value" id="power">--</div>
                        <div class="unit">C√¥ng su·∫•t (W)</div>
                    </div>
                </div>

                <!-- Temperature Grid -->
                <div class="grid">
                    <div class="card">
                        <h3>üå°Ô∏è Nhi·ªát ƒë·ªô</h3>
                        <div class="value" id="temp1">--</div>
                        <div class="unit">Nhi·ªát ƒë·ªô 1 (¬∞C)</div>
                    </div>
                    
                    <div class="card">
                        <h3>üå°Ô∏è Nhi·ªát ƒë·ªô 2</h3>
                        <div class="value" id="temp2">--</div>
                        <div class="unit">Nhi·ªát ƒë·ªô 2 (¬∞C)</div>
                    </div>
                    
                    <div class="card">
                        <h3>üî• Nhi·ªát ƒë·ªô MOS</h3>
                        <div class="value" id="temp-mos">--</div>
                        <div class="unit">Nhi·ªát ƒë·ªô MOS (¬∞C)</div>
                    </div>
                    
                    <div class="card">
                        <h3>üìà Dung l∆∞·ª£ng</h3>
                        <div class="value" id="current-capacity">--</div>
                        <div class="unit">Dung l∆∞·ª£ng hi·ªán t·∫°i (Ah)</div>
                    </div>
                </div>

                <!-- Cell Information -->
                <div class="grid">
                    <div class="card">
                        <h3>üîã Th√¥ng tin Cell</h3>
                        <div class="value" id="min-voltage">--</div>
                        <div class="unit">ƒêi·ªán √°p th·∫•p nh·∫•t (V)</div>
                        <div class="value" id="max-voltage">--</div>
                        <div class="unit">ƒêi·ªán √°p cao nh·∫•t (V)</div>
                        <div class="value" id="avg-voltage">--</div>
                        <div class="unit">ƒêi·ªán √°p trung b√¨nh (V)</div>
                        <div class="value" id="delta-voltage">--</div>
                        <div class="unit">Ch√™nh l·ªách ƒëi·ªán √°p (V)</div>
                    </div>
                    
                    <div class="card">
                        <h3>‚ö° ƒêi·ªán tr·ªü Cell</h3>
                        <div class="value" id="min-resistance">--</div>
                        <div class="unit">ƒêi·ªán tr·ªü th·∫•p nh·∫•t (mŒ©)</div>
                        <div class="value" id="max-resistance">--</div>
                        <div class="unit">ƒêi·ªán tr·ªü cao nh·∫•t (mŒ©)</div>
                        <div class="value" id="avg-resistance">--</div>
                        <div class="unit">ƒêi·ªán tr·ªü trung b√¨nh (mŒ©)</div>
                        <div class="value" id="delta-resistance">--</div>
                        <div class="unit">Ch√™nh l·ªách ƒëi·ªán tr·ªü (mŒ©)</div>
                    </div>
                </div>

                <!-- Cell Voltage Grid -->
                <div class="card">
                    <h3>üîã ƒêi·ªán √°p Cell</h3>
                    <div class="cell-grid" id="cell-grid">
                        <!-- Cell voltages will be populated here -->
                    </div>
                </div>

                <!-- Cell Resistance Grid -->
                <div class="card">
                    <h3>‚ö° ƒêi·ªán tr·ªü Cell</h3>
                    <div class="cell-grid" id="resistance-grid">
                        <!-- Cell resistances will be populated here -->
                    </div>
                </div>

                <!-- Control Section -->
                <div class="control-section">
                    <h2>üéõÔ∏è ƒêi·ªÅu khi·ªÉn ESP32</h2>
                    <div class="control-buttons">
                        <button class="btn btn-danger" onclick="emergencyStop()">üõë D·ª´ng kh·∫©n c·∫•p</button>
                        <button class="btn btn-warning" onclick="restartDevice()">üîÑ Kh·ªüi ƒë·ªông l·∫°i</button>
                        <button class="btn btn-success" onclick="getDeviceStatus()">üìä L·∫•y tr·∫°ng th√°i</button>
                        <button class="btn" onclick="getDeviceData()">üìà L·∫•y d·ªØ li·ªáu</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // MQTT Configuration
        const mqttConfig = {
            host: 'broker.hivemq.com',
            port: 8884, // WebSocket port
            path: '/mqtt',
            clientId: 'BMS_Dashboard_' + Math.random().toString(16).substr(2, 8)
        };

        let mqttClient = null;
        let devices = new Map(); // Map ƒë·ªÉ l∆∞u tr·ªØ th√¥ng tin thi·∫øt b·ªã
        let selectedDeviceId = null; // ID c·ªßa thi·∫øt b·ªã ƒë∆∞·ª£c ch·ªçn
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;

        // K·∫øt n·ªëi MQTT
        function connectMQTT() {
            try {
                const url = `wss://${mqttConfig.host}:${mqttConfig.port}${mqttConfig.path}`;
                
                mqttClient = mqtt.connect(url, {
                    clientId: mqttConfig.clientId,
                    clean: true,
                    reconnectPeriod: 5000,
                    connectTimeout: 30000
                });

                mqttClient.on('connect', () => {
                    console.log('MQTT k·∫øt n·ªëi th√†nh c√¥ng!');
                    updateConnectionStatus('connected', 'ƒê√£ k·∫øt n·ªëi MQTT');
                    showAlert('K·∫øt n·ªëi MQTT th√†nh c√¥ng!', 'success');
                    reconnectAttempts = 0;
                    
                    // Subscribe v√†o t·∫•t c·∫£ topics
                    subscribeToTopics();
                });

                mqttClient.on('message', (topic, message) => {
                    handleMQTTMessage(topic, message.toString());
                });

                mqttClient.on('error', (error) => {
                    console.error('MQTT error:', error);
                    updateConnectionStatus('disconnected', 'L·ªói k·∫øt n·ªëi MQTT');
                    showAlert('L·ªói k·∫øt n·ªëi MQTT: ' + error.message, 'error');
                });

                mqttClient.on('close', () => {
                    console.log('MQTT k·∫øt n·ªëi ƒë√≥ng');
                    updateConnectionStatus('disconnected', 'M·∫•t k·∫øt n·ªëi MQTT');
                    
                    if (reconnectAttempts < maxReconnectAttempts) {
                        reconnectAttempts++;
                        setTimeout(connectMQTT, 5000);
                    }
                });

            } catch (error) {
                console.error('L·ªói k·∫øt n·ªëi MQTT:', error);
                updateConnectionStatus('disconnected', 'L·ªói k·∫øt n·ªëi MQTT');
                showAlert('L·ªói k·∫øt n·ªëi MQTT: ' + error.message, 'error');
            }
        }

        // Subscribe v√†o c√°c topics
        function subscribeToTopics() {
            if (mqttClient && mqttClient.connected) {
                // Subscribe v√†o t·∫•t c·∫£ topics BMS
                mqttClient.subscribe('bms/+/data');
                mqttClient.subscribe('bms/+/status');
                mqttClient.subscribe('bms/+/online');
                
                console.log('ƒê√£ subscribe v√†o topics BMS');
            }
        }

        // X·ª≠ l√Ω tin nh·∫Øn MQTT
        function handleMQTTMessage(topic, message) {
            const topicParts = topic.split('/');
            const deviceId = topicParts[1];
            const messageType = topicParts[2];

            if (!devices.has(deviceId)) {
                devices.set(deviceId, {
                    id: deviceId,
                    status: 'offline',
                    lastSeen: Date.now(),
                    data: {},
                    info: {}
                });
            }

            const device = devices.get(deviceId);
            device.lastSeen = Date.now();

            // online l√† plain text, kh√¥ng ph·∫£i JSON
            if (messageType === 'online') {
                const txt = (message || '').toString().trim();
                device.status = (txt === 'online') ? 'online' : 'offline';
                updateDeviceList();
                if (selectedDeviceId === deviceId) updateBMSInterface(device);
                return;
            }

            try {
                const data = JSON.parse(message);
                if (messageType === 'data') {
                    device.data = data;
                    device.status = 'online';
                } else if (messageType === 'status') {
                    device.info = data;
                    device.status = 'online';
                }

                updateDeviceList();
                if (selectedDeviceId === deviceId) {
                    updateBMSInterface(device);
                }
            } catch (error) {
                console.error('L·ªói x·ª≠ l√Ω tin nh·∫Øn MQTT:', error);
            }
        }

        // C·∫≠p nh·∫≠t danh s√°ch thi·∫øt b·ªã
        function updateDeviceList() {
            const deviceList = document.getElementById('device-list');
            deviceList.innerHTML = '';
            
            devices.forEach((device, deviceId) => {
                const deviceItem = createDeviceItem(device);
                deviceList.appendChild(deviceItem);
            });
        }

        // T·∫°o item thi·∫øt b·ªã
        function createDeviceItem(device) {
            const item = document.createElement('div');
            item.className = `device-item ${selectedDeviceId === device.id ? 'active' : ''}`;
            item.onclick = () => selectDevice(device.id);
            
            const statusClass = device.status === 'online' ? 'status-online' : 'status-offline';
            const statusText = device.status === 'online' ? 'Online' : 'Offline';
            
            const vTxt = (device.data && typeof device.data.v === 'number') ? device.data.v.toFixed(2) + 'V' : '--';
            const socTxt = (device.data && typeof device.data.soc === 'number') ? device.data.soc + '%' : '--';
            const rssi = (device.info && typeof device.info.wifi_rssi === 'number') ? `RSSI ${device.info.wifi_rssi}` : '--';

            item.innerHTML = `
                <div class="device-item-header">
                    <div class="device-name">ESP32 ${device.id}</div>
                    <div class="device-status ${statusClass}">${statusText}</div>
                </div>
                <div class="device-info-small">
                    ${vTxt} | ${socTxt} | ${rssi}
                </div>
            `;
            
            return item;
        }

        // Ch·ªçn thi·∫øt b·ªã
        function selectDevice(deviceId) {
            selectedDeviceId = deviceId;
            const device = devices.get(deviceId);
            
            if (device) {
                // C·∫≠p nh·∫≠t giao di·ªán
                updateBMSInterface(device);
                
                // Hi·ªÉn th·ªã BMS interface
                document.getElementById('welcome-screen').style.display = 'none';
                document.getElementById('bms-interface').classList.add('active');
                
                // C·∫≠p nh·∫≠t danh s√°ch thi·∫øt b·ªã
                updateDeviceList();
                
                // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ
                document.getElementById('selected-device-title').textContent = `ESP32 BMS ${deviceId}`;
                document.getElementById('selected-device-subtitle').textContent = 
                    `IP: ${device.info.local_ip || '--'} | WiFi: ${device.info.wifi_ssid || '--'}`;
            }
        }

        // C·∫≠p nh·∫≠t giao di·ªán BMS
        function updateBMSInterface(device) {
            const d = device.data || {};
            
            // Th√¥ng tin ch√≠nh (v, i, soc, p)
            document.getElementById('battery-voltage').textContent = (d.v ?? '--') === '--' ? '--' : (+d.v).toFixed(2);
            document.getElementById('current').textContent        = (d.i ?? '--') === '--' ? '--' : (+d.i).toFixed(2);
            document.getElementById('soc').textContent            = d.soc ?? '--';
            document.getElementById('power').textContent          = (d.p ?? '--') === '--' ? '--' : (+d.p).toFixed(2);
            
            // Nhi·ªát ƒë·ªô (t1, t2, temp_mos)
            document.getElementById('temp1').textContent    = (d.t1 ?? '--') === '--' ? '--' : (+d.t1).toFixed(1);
            document.getElementById('temp2').textContent    = (d.t2 ?? '--') === '--' ? '--' : (+d.t2).toFixed(1);
            document.getElementById('temp-mos').textContent = (d.temp_mos ?? '--') === '--' ? '--' : (+d.temp_mos).toFixed(1);
            
            // ƒêi·ªán √°p cell (min_v, max_v, avg_v, delta t·ª± t√≠nh)
            const minV = d.min_v, maxV = d.max_v, avgV = d.avg_v;
            const deltaV = (typeof minV === 'number' && typeof maxV === 'number') ? (maxV - minV) : undefined;
            document.getElementById('min-voltage').textContent   = (typeof minV === 'number') ? minV.toFixed(3) : '--';
            document.getElementById('max-voltage').textContent   = (typeof maxV === 'number') ? maxV.toFixed(3) : '--';
            document.getElementById('avg-voltage').textContent   = (typeof avgV === 'number') ? avgV.toFixed(3) : '--';
            document.getElementById('delta-voltage').textContent = (typeof deltaV === 'number') ? deltaV.toFixed(3) : '--';
            
            // L∆∞·ªõi cell: cv l√† mV ‚Üí ƒë·ªïi sang V; fallback sang cell_voltages (V)
            const cellVoltages = Array.isArray(d.cv) ? d.cv.map(mv => mv / 1000) : (d.cell_voltages || []);
            updateCellGrid(cellVoltages, 'cell-grid', 'voltage');
            
            // L∆∞·ªõi ƒëi·ªán tr·ªü (ƒë·ªçc cr n·∫øu c√≥; fallback cell_resistances)
            const cellRes = Array.isArray(d.cr) ? d.cr : (d.cell_resistances || []);
            updateCellGrid(cellRes, 'resistance-grid', 'resistance');

            // T·ªïng h·ª£p ƒëi·ªán tr·ªü: ∆∞u ti√™n min_r/max_r/avg_r/delta_r; n·∫øu thi·∫øu th√¨ t√≠nh t·ª´ m·∫£ng
            const minR   = (typeof d.min_r === 'number')   ? d.min_r   : (cellRes.length ? Math.min(...cellRes) : undefined);
            const maxR   = (typeof d.max_r === 'number')   ? d.max_r   : (cellRes.length ? Math.max(...cellRes) : undefined);
            const avgR   = (typeof d.avg_r === 'number')   ? d.avg_r   : (cellRes.length ? (cellRes.reduce((a,b)=>a+b,0)/cellRes.length) : undefined);
            const deltaR = (typeof d.delta_r === 'number') ? d.delta_r : ((minR!=null && maxR!=null) ? (maxR - minR) : undefined);

            document.getElementById('min-resistance').textContent   = (minR!=null)   ? minR.toFixed(3)   : '--';
            document.getElementById('max-resistance').textContent   = (maxR!=null)   ? maxR.toFixed(3)   : '--';
            document.getElementById('avg-resistance').textContent   = (avgR!=null)   ? avgR.toFixed(3)   : '--';
            document.getElementById('delta-resistance').textContent = (deltaR!=null) ? deltaR.toFixed(3) : '--';
        }

        // C·∫≠p nh·∫≠t cell grid
        function updateCellGrid(cellData, gridId, type) {
            const grid = document.getElementById(gridId);
            if (!cellData || cellData.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #666;">Ch∆∞a c√≥ d·ªØ li·ªáu</div>';
                return;
            }
            
            grid.innerHTML = '';
            
            cellData.forEach((value, index) => {
                const cell = document.createElement('div');
                cell.className = 'cell';
                
                let cssClass = '';
                if (type === 'voltage') {
                    if (value > 3.65) cssClass = 'voltage-high';
                    else if (value < 3.0) cssClass = 'voltage-low';
                    else cssClass = 'voltage-normal';
                } else if (type === 'resistance') {
                    if (value > 2.0) cssClass = 'resistance-high';
                    else if (value < 0.5) cssClass = 'resistance-low';
                    else cssClass = 'resistance-normal';
                }
                
                cell.className = `cell ${cssClass}`;
                cell.innerHTML = `
                    <div class="cell-number">Cell ${index + 1}</div>
                    <div class="cell-value">${value.toFixed(3)}</div>
                `;
                
                grid.appendChild(cell);
            });
        }

        // C·∫≠p nh·∫≠t tr·∫°ng th√°i k·∫øt n·ªëi
        function updateConnectionStatus(status, text) {
            const indicator = document.getElementById('mqtt-status-indicator');
            const textElement = document.getElementById('mqtt-status-text');
            
            indicator.className = `status-indicator status-${status}`;
            textElement.textContent = text;
        }

        // Hi·ªÉn th·ªã th√¥ng b√°o
        function showAlert(message, type = 'info') {
            const alertsContainer = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            
            alertsContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // ƒêi·ªÅu khi·ªÉn thi·∫øt b·ªã
        function emergencyStop() {
            if (selectedDeviceId && confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën d·ª´ng kh·∫©n c·∫•p thi·∫øt b·ªã ${selectedDeviceId}?`)) {
                publishCommand(selectedDeviceId, 'emergency_stop');
                showAlert(`ƒê√£ g·ª≠i l·ªánh d·ª´ng kh·∫©n c·∫•p thi·∫øt b·ªã ${selectedDeviceId}`, 'success');
            }
        }

        function restartDevice() {
            if (selectedDeviceId && confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën kh·ªüi ƒë·ªông l·∫°i thi·∫øt b·ªã ${selectedDeviceId}?`)) {
                publishCommand(selectedDeviceId, 'restart');
                showAlert(`ƒê√£ g·ª≠i l·ªánh kh·ªüi ƒë·ªông l·∫°i thi·∫øt b·ªã ${selectedDeviceId}`, 'success');
            }
        }

        function getDeviceStatus() {
            if (selectedDeviceId) {
                publishCommand(selectedDeviceId, 'get_status');
                showAlert(`ƒê√£ y√™u c·∫ßu tr·∫°ng th√°i thi·∫øt b·ªã ${selectedDeviceId}`, 'success');
            }
        }

        function getDeviceData() {
            if (selectedDeviceId) {
                publishCommand(selectedDeviceId, 'get_data');
                showAlert(`ƒê√£ y√™u c·∫ßu d·ªØ li·ªáu thi·∫øt b·ªã ${selectedDeviceId}`, 'success');
            }
        }

        // G·ª≠i l·ªánh qua MQTT
        function publishCommand(deviceId, command) {
            if (mqttClient && mqttClient.connected) {
                const topic = `bms/${deviceId}/control`;
                mqttClient.publish(topic, command);
                console.log(`ƒê√£ g·ª≠i l·ªánh ${command} t·ªõi ${topic}`);
            } else {
                showAlert('Kh√¥ng th·ªÉ g·ª≠i l·ªánh - MQTT ch∆∞a k·∫øt n·ªëi', 'error');
            }
        }

        // Kh·ªüi t·∫°o dashboard
        function initDashboard() {
            console.log('Kh·ªüi t·∫°o BMS Central Dashboard...');
            connectMQTT();
            
            // C·∫≠p nh·∫≠t tr·∫°ng th√°i thi·∫øt b·ªã m·ªói 30 gi√¢y
            setInterval(() => {
                const now = Date.now();
                devices.forEach((device, deviceId) => {
                    if (now - device.lastSeen > 60000) { // 1 ph√∫t
                        device.status = 'offline';
                        updateDeviceList();
                        
                        // N·∫øu ƒëang ch·ªçn thi·∫øt b·ªã offline, quay v·ªÅ welcome screen
                        if (selectedDeviceId === deviceId) {
                            selectedDeviceId = null;
                            document.getElementById('welcome-screen').style.display = 'block';
                            document.getElementById('bms-interface').classList.remove('active');
                        }
                    }
                });
            }, 30000);
        }

        // Kh·ªüi t·∫°o khi trang load xong
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>
